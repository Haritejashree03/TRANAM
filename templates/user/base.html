<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRANAM - {% block title %}{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                {% if session.get('user_id') and session.get('user_type') == 'user' %}
                <!-- Profile Button (only visible when logged in) -->
                <button class="btn btn-link p-0 me-3" data-bs-toggle="modal" data-bs-target="#profileModal" style="border:none;">
                    <img src="{{ profile_image }}" alt="Profile"
                         class="rounded-circle border border-2"
                         style="width:45px;height:45px;object-fit:cover;">
                </button>
                {% endif %}
                <a class="navbar-brand" href="{{ url_for('user_dashboard') if session.get('user_type') == 'user' else url_for('index') }}">
                    <i class="fas fa-shield-alt"></i> TRANAM
                </a>
            </div>

            <div class="navbar-nav ms-auto">
                {% if session.get('user_id') and session.get('user_type') == 'user' %}
                    <a class="nav-link" href="{{ url_for('user_dashboard') }}">Home</a>
                    <a class="nav-link" href="{{ url_for('user_videos') }}">Videos</a>
                    <a class="nav-link" href="{{ url_for('user_guardian') }}">Guardian</a>
                    <a class="nav-link" href="{{ url_for('user_logout') }}">Logout</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Editable Profile Modal -->
    {% if session.get('user_id') and session.get('user_type') == 'user' %}
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
          <!-- Header -->
          <div class="modal-header text-white"
               style="background: linear-gradient(to right,#e83e8c,#007bff);">
            <h5 class="modal-title"><i class="fas fa-user-circle me-2"></i> My Profile</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>

          <!-- Body -->
          <div class="modal-body text-center">
            <form id="profileForm" enctype="multipart/form-data">
              <img id="profilePreview" src="{{ profile_image }}"
                   class="rounded-circle mb-3 border border-3 shadow-sm"
                   style="width:110px;height:110px;object-fit:cover;cursor:pointer;">
              <input type="file" id="profilePicInput" name="profile_pic" accept="image/*" style="display:none;">

              <div class="text-start px-4">
                <label class="fw-bold mt-2">Name</label>
                <input class="form-control" name="name" value="{{ current_user.name }}" disabled>

                <label class="fw-bold mt-2">Email</label>
                <input class="form-control" name="email" value="{{ current_user.email }}" disabled readonly>

                <label class="fw-bold mt-2">Phone</label>
                <input class="form-control" name="phone" value="{{ current_user.phone }}" disabled>

                <label class="fw-bold mt-2">Gender</label>
                <select class="form-select" name="gender" disabled>
                  <option value="Female" {% if current_user.gender=='Female' %}selected{% endif %}>Female</option>
                  <option value="Male" {% if current_user.gender=='Male' %}selected{% endif %}>Male</option>
                  <option value="Other" {% if current_user.gender=='Other' %}selected{% endif %}>Other</option>
                </select>

                <label class="fw-bold mt-2">Address</label>
                <textarea class="form-control" name="address" rows="2" disabled>{{ current_user.address }}</textarea>
              </div>
            </form>
          </div>

          <!-- Footer -->
          <div class="modal-footer justify-content-center">
            <button id="editBtn" class="btn btn-pink px-4"><i class="fas fa-edit me-2"></i>Edit Profile</button>
            <button id="saveBtn" class="btn btn-success px-4" style="display:none;"><i class="fas fa-save me-2"></i>Save Changes</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Flash Messages -->
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap & JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    {% block scripts %}{% endblock %}

    <!-- Modal Script (Edit + Save + Image Preview + AJAX) -->
    <script>
    document.addEventListener("DOMContentLoaded",()=>{
      const editBtn=document.getElementById("editBtn");
      const saveBtn=document.getElementById("saveBtn");
      const form=document.getElementById("profileForm");
      const inputs=form?.querySelectorAll("input,textarea,select");
      const picInput=document.getElementById("profilePicInput");
      const preview=document.getElementById("profilePreview");

      if(!editBtn)return;

      // open file dialog
      preview.addEventListener("click",()=>{
        if(!preview.classList.contains("editable"))return;
        picInput.click();
      });

      // live preview
      picInput.addEventListener("change",e=>{
        const file=e.target.files[0];
        if(file){
          const reader=new FileReader();
          reader.onload=ev=>preview.src=ev.target.result;
          reader.readAsDataURL(file);
        }
      });

      // enable edit mode
      editBtn.addEventListener("click",()=>{
        inputs.forEach(i=>i.disabled=false);
        preview.classList.add("editable");
        editBtn.style.display="none";
        saveBtn.style.display="inline-block";
      });

      // save profile via AJAX
      saveBtn.addEventListener("click",async()=>{
        const fd=new FormData(form);
        const res=await fetch("/user/update-profile",{method:"POST",body:fd});
        const data=await res.json();
        showToast(data.message || "Profile updated!");
        if(data.message) setTimeout(()=>location.reload(),1500);
      });

      // toast feedback
      function showToast(msg){
        const toast=document.createElement("div");
        toast.className="toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-3";
        toast.style.zIndex="9999";
        toast.innerHTML=`<div class='d-flex'><div class='toast-body'>${msg}</div>
        <button type='button' class='btn-close btn-close-white me-2 m-auto' data-bs-dismiss='toast'></button></div>`;
        document.body.appendChild(toast);
        const bsToast=new bootstrap.Toast(toast,{delay:2000});
        bsToast.show();
      }
    });
    </script>

    <!-- Styles -->
    <style>
    .btn-pink {
      background-color:#e83e8c;
      color:white;
      border:none;
      border-radius:25px;
      transition:0.3s;
    }
    .btn-pink:hover {
      background-color:#d61e73;
      transform:translateY(-2px);
    }
    .toast {font-size:15px;}
    </style>
</body>
</html>