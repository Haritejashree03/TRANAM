{% extends "user/base.html" %}
{% block title %}Forgot Password{% endblock %}

{% block content %}
<div class="login-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="login-card shadow">
                    <div class="text-center mb-4">
                        <i class="fas fa-key fa-3x mb-3" style="color: var(--primary-pink);"></i>
                        <h2 style="color: var(--primary-pink);">Reset Your Password</h2>
                        <p class="text-muted">Enter your email, get verification code, verify, and reset your password.</p>
                    </div>

                    <form id="forgotPasswordForm">
                        <!-- Email -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-envelope me-2" style="color: var(--primary-pink);"></i>Email Address
                            </label>
                            <input type="email" class="form-control" id="email"
                                placeholder="Enter your registered email address" required>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-pink w-75" id="getCodeBtn">
                                    <i class="fas fa-paper-plane me-2"></i>Get Verification Code
                                </button>
                            </div>
                            <div class="form-text">We'll send a verification code to this email.</div>
                        </div>

                        <!-- Verification Section -->
                        <div id="verificationSection" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-shield-alt me-2" style="color: var(--primary-pink);"></i>
                                    Verification Code
                                </label>
                                <input type="text" class="form-control" id="verificationCode"
                                    placeholder="Enter 6-digit code" maxlength="6" required>
                                <div id="verificationHelp" class="form-text">Check your email for the code.</div>
                            </div>
                            <div class="d-flex justify-content-center gap-2 mb-3">
                                <button type="button" class="btn btn-pink w-50" id="verifyBtn">Verify Code</button>
                                <button type="button" class="btn btn-outline-pink w-50" id="resendBtn" disabled>Resend</button>
                            </div>
                        </div>

                        <!-- Password Section -->
                        <div id="passwordSection" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-lock me-2" style="color: var(--primary-pink);"></i>New Password
                                </label>
                                <input type="password" class="form-control" id="newPassword" required minlength="8"
                                    placeholder="Enter new password">
                                <div class="password-requirements">
                                    <small class="text-muted">Password must contain:</small>
                                    <ul class="small text-muted mb-0">
                                        <li id="length" class="text-danger">At least 8 characters</li>
                                        <li id="uppercase" class="text-danger">One uppercase letter</li>
                                        <li id="lowercase" class="text-danger">One lowercase letter</li>
                                        <li id="number" class="text-danger">One number</li>
                                        <li id="special" class="text-danger">One special character</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-lock me-2" style="color: var(--primary-pink);"></i>Confirm Password
                                </label>
                                <input type="password" class="form-control" id="confirmPassword" required
                                    placeholder="Confirm your new password">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Password Strength:</label>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div id="passwordStrength" class="progress-bar" style="width: 0%; background-color: #dc3545;"></div>
                                </div>
                                <small id="strengthText" class="text-muted">Enter a password to check strength</small>
                            </div>

                            <button type="submit" class="btn btn-pink w-100 mb-3" id="resetBtn" disabled>
                                <i class="fas fa-sync-alt me-2"></i>Reset Password
                            </button>
                        </div>

                        <div class="text-center">
                            <a href="{{ url_for('user_login') }}" class="text-decoration-none">
                                <i class="fas fa-arrow-left me-1"></i>Back to Login
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.btn-pink { background-color: #e83e8c; color: white; border: none; border-radius: 30px; }
.btn-pink:hover { background-color: #d81b60; }
.btn-outline-pink { border: 1px solid #e83e8c; color: #e83e8c; border-radius: 30px; }
.btn-outline-pink:hover { background-color: #e83e8c; color: white; }
.password-requirements ul { padding-left: 20px; }
.password-requirements li.valid { color: #28a745 !important; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const email = document.getElementById('email');
    const getCodeBtn = document.getElementById('getCodeBtn');
    const verificationSection = document.getElementById('verificationSection');
    const verificationCode = document.getElementById('verificationCode');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendBtn = document.getElementById('resendBtn');
    const verificationHelp = document.getElementById('verificationHelp');
    const passwordSection = document.getElementById('passwordSection');
    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const resetBtn = document.getElementById('resetBtn');
    const strengthBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('strengthText');

    let verified = false;
    let countdownTimer;

    // Password requirements
    const requirements = {
        length: /.{8,}/,
        uppercase: /[A-Z]/,
        lowercase: /[a-z]/,
        number: /[0-9]/,
        special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/,
    };

    // Utility: Notification
    function showNotification(msg, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alert.innerHTML = `${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.querySelector('.container').prepend(alert);
        setTimeout(() => alert.remove(), 4000);
    }

    // Get verification code
    getCodeBtn.addEventListener('click', async function() {
        if (!email.checkValidity()) return showNotification('Please enter a valid email.', 'danger');
        getCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
        getCodeBtn.disabled = true;

        try {
            const response = await fetch('/send-verification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email.value })
            });
            const result = await response.json();
            if (response.ok) {
                showNotification(result.message, 'success');
                verificationSection.style.display = 'block';
                startCountdown();
            } else {
                showNotification(result.error, 'danger');
            }
        } catch {
            showNotification('Server error while sending code.', 'danger');
        } finally {
            getCodeBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Get Verification Code';
            getCodeBtn.disabled = false;
        }
    });

    // Verify Code
    verifyBtn.addEventListener('click', async function() {
        if (verificationCode.value.length !== 6)
            return showNotification('Enter a valid 6-digit code.', 'danger');
        verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
        verifyBtn.disabled = true;

        try {
            const response = await fetch('/verify-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email.value,
                    verification_code: verificationCode.value
                })
            });
            const result = await response.json();
            if (response.ok) {
                showNotification('Code verified successfully!', 'success');
                passwordSection.style.display = 'block';
                verified = true;
                verifyBtn.textContent = 'Verified âœ“';
                verifyBtn.disabled = true;
            } else {
                showNotification(result.error || 'Invalid verification code.', 'danger');
                verifyBtn.textContent = 'Verify Code';
                verifyBtn.disabled = false;
            }
        } catch {
            showNotification('Server error verifying code.', 'danger');
            verifyBtn.textContent = 'Verify Code';
            verifyBtn.disabled = false;
        }
    });

    // Countdown Timer
    function startCountdown() {
        let timeLeft = 300; // 5 minutes
        resendBtn.disabled = true;
        clearInterval(countdownTimer);
        countdownTimer = setInterval(() => {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            verificationHelp.textContent = `Code expires in ${m}:${s < 10 ? '0' : ''}${s}`;
            if (--timeLeft <= 0) {
                clearInterval(countdownTimer);
                verificationHelp.textContent = 'Code expired. Please resend.';
                resendBtn.disabled = false;
            }
        }, 1000);
    }

    resendBtn.addEventListener('click', () => {
        verificationCode.value = '';
        showNotification('Requesting new code...', 'info');
        getCodeBtn.click();
    });

    // Password Strength
    newPassword.addEventListener('input', function() {
        const pw = newPassword.value;
        let validCount = 0;
        for (const [key, regex] of Object.entries(requirements)) {
            const el = document.getElementById(key);
            if (regex.test(pw)) { el.classList.add('valid'); el.classList.remove('text-danger'); validCount++; }
            else { el.classList.remove('valid'); el.classList.add('text-danger'); }
        }
        const percent = (validCount / 5) * 100;
        strengthBar.style.width = percent + '%';
        const colors = ['#dc3545', '#fd7e14', '#ffc107', '#20c997', '#28a745'];
        strengthBar.style.backgroundColor = colors[Math.floor(validCount)];
        strengthText.textContent = ['Very Weak','Weak','Fair','Good','Strong'][Math.floor(validCount)];
        updateResetState();
    });

    confirmPassword.addEventListener('input', updateResetState);

    function updateResetState() {
        const pw = newPassword.value;
        const match = pw === confirmPassword.value && pw.length > 0;
        const valid = Object.values(requirements).every(r => r.test(pw));
        resetBtn.disabled = !(match && valid && verified);
    }

    // Submit Reset
    document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!verified) return showNotification('Please verify your code first.', 'danger');
        resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetting...';
        resetBtn.disabled = true;

        try {
            const response = await fetch('/user/forgot-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email.value,
                    verification_code: verificationCode.value,
                    new_password: newPassword.value
                })
            });
            const result = await response.json();
            if (response.ok) {
                showNotification('Password reset successful! Redirecting...', 'success');
                setTimeout(() => window.location.href = "{{ url_for('user_login') }}", 2000);
            } else {
                showNotification(result.error || 'Failed to reset password.', 'danger');
            }
        } catch {
            showNotification('Server error resetting password.', 'danger');
        } finally {
            resetBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Reset Password';
        }
    });
});
</script>
{% endblock %}