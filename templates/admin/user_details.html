{% extends "admin/base.html" %}
{% block title %}User Details - {{ user.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4" style="color: var(--primary-pink);">
            <i class="fas fa-user"></i> User Details: {{ user.name }}
        </h2>
    </div>
</div>

<div class="row">
    <!-- LEFT PROFILE CARD -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                {% if user.profile_pic %}
                <img src="{{ url_for('static', filename='uploads/profile_pics/' + user.profile_pic) }}" 
                     class="profile-pic mb-3">
                {% else %}
                <img src="https://via.placeholder.com/150" class="profile-pic mb-3">
                {% endif %}

                <h5>{{ user.name }}</h5>
                <p class="text-muted">{{ user.email }}</p>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <h6>Quick Actions</h6>
                <a href="tel:{{ user.phone }}" class="btn btn-outline-pink w-100 mb-2">
                    <i class="fas fa-phone"></i> Call User
                </a>
                <a href="tel:{{ user.guardian_no }}" class="btn btn-outline-pink w-100 mb-2">
                    <i class="fas fa-phone-alt"></i> Call Guardian
                </a>
                <a href="javascript:void(0)"onclick="openTrackLocation('{{ user.notifications[-1].location if user.notifications else '' }}')"class="btn btn-outline-pink w-100">
                   <i class="fas fa-map-marker-alt"></i> Track Location
                </a>
                <a href="{{ url_for('admin_view_media', user_id=user.id) }}"class="btn btn-outline-pink w-100 mb-2">
                   <i class="fas fa-photo-video"></i> View Media
                </a>
            </div>
        </div>
    </div>

    <!-- RIGHT INFO SECTION -->
    <div class="col-md-8">

        <!-- PERSONAL INFO -->
        <div class="card">
            <div class="card-body">
                <h5 style="color:var(--primary-pink);">Personal Information</h5>

                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Email:</strong> {{ user.email }}</p>
                        <p><strong>Phone:</strong> {{ user.phone }}</p>
                        <p><strong>Gender:</strong> {{ user.gender }}</p>
                    </div>

                    <div class="col-md-6">
                        <p><strong>Registered:</strong> {{ user.created_at.strftime('%Y-%m-%d') }}</p>
                    </div>
                </div>

                <h6 class="mt-3">Address</h6>
                <p>{{ user.address }}</p>
            </div>
        </div>

<!-- GUARDIAN INFO -->
<div class="card mt-3">
    <div class="card-body">
        <h5 style="color:var(--primary-pink);">
            <i class="fas fa-user-shield"></i> Guardian Information
        </h5>

        <!-- PRIMARY GUARDIAN -->
        <div class="alert alert-danger">
            <h6><i class="fas fa-phone-alt"></i> Primary Guardian</h6>
            <p><strong>Name:</strong> {{ user.guardian_name }}</p>
            <p><strong>Phone:</strong> {{ user.guardian_no }}</p>
            <p><strong>Email:</strong> {{ user.guardian_email }}</p>
        </div>

        <!-- SECONDARY GUARDIANS -->
        <h6 class="mt-3">Other Guardians</h6>

        {% if guardians %}
            <div class="list-group">
                {% for g in guardians %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between">
                        <strong>{{ g.name }}</strong>
                        <small>{{ g.relationship }}</small>
                    </div>
                    <p class="mb-1"><strong>Phone:</strong> {{ g.phone }}</p>
                    {% if g.email %}
                    <p class="mb-0"><strong>Email:</strong> {{ g.email }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted mt-2">No additional guardians added.</p>
        {% endif %}

        <!-- EMERGENCY HISTORY -->
        <h6 class="mt-4">Emergency History</h6>
        <div class="list-group">
            {% for n in user.notifications %}
            <div class="list-group-item">
                <div class="d-flex justify-content-between">
                    <h6>{{ n.message }}</h6>
                    <small>{{ n.created_at.strftime('%H:%M') }}</small>
                </div>
                <p>Location: {{ n.location or 'Unknown' }}</p>
            </div>
            {% else %}
            <div class="text-center py-3 text-muted">
                No emergency history.
            </div>
            {% endfor %}
        </div>
    </div>
</div>


<!-- TRACK LOCATION MODAL -->
<div class="modal fade" id="trackLocationModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="color: var(--primary-pink);">
          <i class="fas fa-map-marker-alt"></i> Live User Location
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="trackLocationMap" style="height: 400px; border-radius: 10px;"></div>

        <div class="mt-3">
          <p><strong>Coordinates:</strong> <span id="trackLocationCoords"></span></p>
        </div>
      </div>

    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
let tMap = null;

function openTrackLocation(locationString) {
    if (!locationString || locationString === "Unknown") {
        alert("No location available for this user.");
        return;
    }

    const [lat, lon] = locationString.split(',').map(parseFloat);

    document.getElementById('trackLocationCoords').innerText = locationString;

    const modal = new bootstrap.Modal(document.getElementById('trackLocationModal'));
    modal.show();

    setTimeout(() => {
        if (!tMap) {
            tMap = L.map('trackLocationMap').setView([lat, lon], 15);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(tMap);
        }
        L.marker([lat, lon]).addTo(tMap);
        tMap.setView([lat, lon], 15);
    }, 300);
}
</script>


{% endblock %}